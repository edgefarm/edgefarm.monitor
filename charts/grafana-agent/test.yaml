---
# Source: grafana-agent-operator/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-agent-yml
  namespace: nodegroup
  labels:
    k8s-app: grafana-agent
data:
  agent.yaml: |
    server:
      log_level: info
    metrics:
      global:
        scrape_interval: 1m
        remote_write:
          - url: http://grafana-mimir-nginx.monitoring.svc:80/api/v1/push
      configs:
        - name: default
          scrape_configs:
            - job_name: agent
              static_configs:
                - targets: [edgeapplication-node-exporter-prometheus-node-exporter.nodegroup.svc:9100]
          remote_write:
            - url: http://grafana-mimir-nginx.monitoring.svc:80/api/v1/push
              basic_auth: 
                username: nats
                password: YjU3ZGQ5YzFhYWRlM2Y3OWI1YjJkZTE1
---
# Source: grafana-agent-operator/templates/operator-deployment.yaml
apiVersion: apps.kubeedge.io/v1alpha1
kind: EdgeApplication
metadata:
  name: grafana-agent
  labels: 
    app.kubernetes.io/name: grafana-agent
  namespace: nodegroup
spec:
  workloadTemplate:
    manifests:
      - apiVersion: apps/v1
        kind: Deployment
        metadata:
          namespace: nodegroup
          name: edgeapplication-grafana-agent-grafana-agent-operator
          labels:
            app.kubernetes.io/name: grafana-agent-operator
            app.kubernetes.io/instance: edgeapplication-grafana-agent
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/component: operator
            helm.sh/chart: grafana-agent-operator-0.2.8
            app.kubernetes.io/version: "0.28.0"
        spec:
          replicas: 1
          selector:
            matchLabels:
              app.kubernetes.io/name: grafana-agent-operator
              app.kubernetes.io/instance: edgeapplication-grafana-agent
          template:
            metadata:
              labels:
                app.kubernetes.io/name: grafana-agent-operator
                app.kubernetes.io/instance: edgeapplication-grafana-agent
            spec:
              containers:
              - name: grafana-agent-operator
                image: "docker.io/grafana/agent:v0.28.0"
                imagePullPolicy: IfNotPresent
                volumeMounts: 
                  - name: agent-yaml
                    mountPath: /etc/agent/
                args:
              volumes:
                - name: agent-yaml
                  configMap: 
                    name: grafana-agent-yml
              tolerations:
                - effect: NoExecute
                  key: edgefarm.applications
                  operator: Exists
              affinity:
                nodeAffinity:
                  requiredDuringSchedulingIgnoredDuringExecution:
                    nodeSelectorTerms:
                    - matchExpressions:
                      - key: node-role.kubernetes.io/edge
                        operator: Exists
  workloadScope:
    targetNodeGroups:
      - name: virtual-20f5cc6c
      - name: virtual-65d94b8e
